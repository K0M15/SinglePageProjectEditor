(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class E{constructor(e,t){this.editorElementId=e,this.type=t}toggleEditor(){console.error("Should be implemented by Class")}delete(){}async serialize(){throw Error("Object serialization should be implemented by child class")}static fromDataObj(e){throw Error("Object serialization should be implemented by child class")}}class p extends E{constructor(e){super(e,"Text"),this.pageElement=document.createElement("div"),this.pageElement.classList.add("editorText"),this.buttonContainer=document.createElement("div"),this.buttonContainer.classList.add("elem-btn-cont");let t=document.createElement("button");t.innerHTML="🗑️",t.onclick=()=>{this.delete()},this.buttonContainer.appendChild(t),this.pageElement.appendChild(this.buttonContainer),this.textareaElement=document.createElement("textarea"),this.pageElement.appendChild(this.textareaElement),this.pageElement.ondblclick=()=>{this.toggleEditor()},this.displayElement=document.createElement("div"),this.displayElement.classList.add("displayText"),this.pageElement.appendChild(this.displayElement),document.body.insertBefore(this.pageElement,document.getElementById("pageEnd"))}toggleEditor(){this.pageElement.classList.contains("editMode")?(this.pageElement.classList.remove("editMode"),this.render()):this.pageElement.classList.add("editMode")}render(){let e=this.textareaElement.value;this.displayElement.innerHTML=this.replaceMD(e)}replaceMD(e){return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(new RegExp("(?<!^)>","gm"),"&gt;"),e=e.replace(/^> (.*)$/gm,"<blockquote>$1</blockquote>"),e=e.replace(/```([\s\S]*?)```/g,(t,a)=>`<pre class="code-block"><code>${a}</code></pre>`),e=e.replace(/`([^`\n]+)`/g,"<code>$1</code>"),e=e.replace(/^###### (.*)$/gm,"<h6>$1</h6>"),e=e.replace(/^##### (.*)$/gm,"<h5>$1</h5>"),e=e.replace(/^#### (.*)$/gm,"<h4>$1</h4>"),e=e.replace(/^### (.*)$/gm,"<h3>$1</h3>"),e=e.replace(/^## (.*)$/gm,"<h2>$1</h2>"),e=e.replace(/^# (.*)$/gm,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__(.*?)__/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/_(.*?)_/g,"<em>$1</em>"),e=e.replace(/^\d+\. (.*)$/gm,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/gms,"<ol>$1</ol>"),e=e.replace(/^[-+*] (.*)$/gm,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/gms,"<ul>$1</ul>"),e=e.replace(/^(?!<h|<ul>|<ol>|<li>|<blockquote>|<pre>|<p>|<code>)(.+)$/gm,"<p>$1</p>"),e}delete(){this.pageElement.remove(),super.delete()}async serialize(){return{panelType:this.type,data:this.textareaElement.value,id:this.editorElementId}}static fromDataObj(e){if(e.id===void 0||e.data===void 0)throw Error("obj corrupted");const t=new p(e.id);return t.textareaElement.value=e.data,t.render(),t}}class m extends E{constructor(e){super(e,"Picture"),this.pageElement=document.createElement("div"),this.pageElement.classList.add("editorPicture","editMode"),this.imageElement=document.createElement("img"),this.imageElement.src="",this.editorElement=document.createElement("div"),this.editorElement.classList.add("edit");let t=document.createElement("button"),a=document.createElement("label");this.fileSelectorElement=document.createElement("input"),t.innerText="Select Local",t.onclick=()=>{this.fileSelectorElement.click()},this.fileSelectorElement.type="file",this.fileSelectorElement.accept="image/*,.svg",this.fileSelectorElement.hidden=!0,a.classList.add("file-button"),a.appendChild(t),a.appendChild(this.fileSelectorElement),this.linkSelectorElement=document.createElement("input"),this.linkSelectorElement.type="text",this.linkSelectorElement.placeholder="Paste Webpath",this.editorElement.appendChild(a),this.editorElement.appendChild(this.linkSelectorElement);let n=document.createElement("button");n.onclick=()=>{this.toggleEditor()},n.innerText="Close",this.editorElement.appendChild(n),this.pageElement.appendChild(this.editorElement),this.pageElement.appendChild(this.imageElement),this.pageElement.ondblclick=()=>{this.toggleEditor()},document.body.insertBefore(this.pageElement,document.getElementById("pageEnd"))}toggleEditor(){if(this.pageElement.classList.contains("editMode")){if(this.pageElement.classList.remove("editMode"),this.linkSelectorElement.value)this.imageElement.src=this.linkSelectorElement.value;else if(this.fileSelectorElement.value&&this.fileSelectorElement.files!=null){const e=this.fileSelectorElement.files[0];if(!e)return;const t=new FileReader;t.onload=a=>{a.target!=null&&a.target.result!=null&&typeof a.target.result=="string"&&(this.imageElement.src=a.target.result)},t.readAsDataURL(e)}}else this.pageElement.classList.add("editMode")}delete(){this.pageElement.remove(),super.delete()}async saveLoadedImageData(){const e=await caches.open("spe-images"),t=await fetch(this.imageElement.src);if(!t.ok)throw Error(`Could not fetch image 			${this.editorElementId} from Source ${this.imageElement.src}			`);const a=await t.blob(),n=`http://synthetic.spe/${this.editorElementId}`;return await e.put(new Request(n),new Response(a,{headers:{"Content-Type":a.type}})),n}async serialize(){return{id:this.editorElementId,panelType:this.type,data:await this.saveLoadedImageData()}}static fromDataObj(e){if(e.id===void 0||e.data===void 0)throw Error("obj corrupted");const t=new m(e.id);return caches.open("spe-images").then(a=>a.match(e.data).then(n=>{if(n===void 0)throw Error(`No match for ${e.data} in cache "spe-images". Corrupted data?`);n.blob().then(i=>{t.imageElement.src=URL.createObjectURL(i),t.linkSelectorElement.value=t.imageElement.src})})),t.toggleEditor(),t}}class u extends E{constructor(e){super(e,"Action"),this.data=[["","Description","Responsible","Date"]],this.pageElement=document.createElement("div"),this.pageElement.classList.add("editorAction"),document.body.insertBefore(this.pageElement,document.getElementById("pageEnd")),this.render()}render(){let e=document.createElement("table"),t=document.createElement("tr");t.append(...this.data[0].map(s=>{let l=document.createElement("th");return l.innerText=s,l})),e.appendChild(t);let a=1;for(;a<this.data.length;){let s=document.createElement("tr");s.append(...this.data[a].map((l,r)=>this.handleFieldData(l,a,r))),e.appendChild(s),a++}let n=document.createElement("tr");n.classList.add("editorActionLastRow");let i=document.createElement("button");i.onclick=()=>{this.add_row()},i.innerText="Add",i.classList.add("new"),n.appendChild(i),e.appendChild(n),this.pageElement.replaceChildren(e)}add_row(){this.data.push([!1,null,null,null]),this.render()}handleFieldData(e,t,a){let n=document.createElement("td");const i=()=>{n.ondblclick=()=>{let s=document.createElement("input");s.onblur=l=>{this.data[t][a]=s.value,this.render()},n.replaceChildren(s),s.focus()}};if(a==0){let s=document.createElement("input");s.type="checkbox",s.onchange=()=>{console.log(s.checked),this.data[t][a]=s.checked},typeof e=="boolean"?s.checked=e:s.checked=!1,n.appendChild(s)}else if(typeof e=="string"&&!isNaN(Date.parse(e)))n.innerText=Date.parse(e).toLocaleString(),i();else if(typeof e=="string"&&e!="")n.innerText=e,i();else if(e===null||e==""){let s=document.createElement("input");s.onblur=l=>{this.data[t][a]=s.value,this.render()},n.appendChild(s)}return n}async serialize(){return{panelType:this.type,id:this.editorElementId,data:JSON.stringify(this.data)}}static fromDataObj(e){if(e.id===void 0||e.data===void 0)throw Error("obj corrupted");const t=new u(e.id);return t.data=JSON.parse(e.data),t.render(),t}}const v=[{cls:p,fromObject:p.fromDataObj,name:"Text",description:"A Markdown-Formated textfield"},{cls:m,fromObject:m.fromDataObj,name:"Picture",description:"A Picture from a link or from a file"},{cls:u,fromObject:u.fromDataObj,name:"Action",description:"An Element oranizing actions"}];function c(){const o=new Uint8Array(12);return crypto.getRandomValues(o),Array.from(o).map(e=>e.toString(16).padStart(2,"0")).join("")}class b{constructor(e){this.isLoggedIn=!1,this.checkLogin().then(t=>{this.isLoggedIn=t}).catch(()=>{e()})}async register(e,t){var n;const a=await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(a.status!=201)throw Error(`Registration failed: Server returned status ${a.status}and message ${await((n=a.body)==null?void 0:n.getReader().read())}`);return this.login(e,t)}async login(e,t){if((await fetch("/login",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})})).status!=200)throw Error("Login failed")}async getOverview(){this.isLoggedIn||await this.checkLogin();const e=await fetch("/toc",{credentials:"include"});if(!e.ok)throw Error(`Request returned status ${e.status}`);return await e.json()}async setOverview(e){this.isLoggedIn||await this.checkLogin();const t=await fetch("/toc",{method:"POST",credentials:"include",body:JSON.stringify(e)});if(!t.ok)throw Error(`Request returned status ${t.status}`)}async checkLogin(){const e=await fetch("/check",{credentials:"include"});if(this.isLoggedIn=e.ok,!e.ok)throw Error("Not logged in!");return e.ok}async requestDocument(e){this.isLoggedIn||await this.checkLogin();const t=await fetch("/load",{credentials:"include",body:JSON.stringify({documentId:e})});if(!t.ok)throw Error(`Request returned status ${t.status}`);return await t.json()}async saveDocument(e,t){this.isLoggedIn||await this.checkLogin();const a=await fetch("/save",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,data:t})});if(!a.ok)throw Error(`Request returned status ${a.status}`)}}class y{constructor(){this.pageElements=[]}async serialize(){return await Promise.all(this.pageElements.map(e=>e.serialize()))}push(...e){this.pageElements.push(...e)}}class S{constructor(){this.state=new y,this.openedState={id:c(),name:void 0,ts:Date.now(),panels:[]},this.availableStates=[],this.loadAvailableStates()}loadAvailableStates(){try{const e=localStorage.getItem("spe-pages");if(e===null)return!1;this.availableStates.push(...JSON.parse(e))}catch{this.saveAvailableStates()}}updateAvailableStates(e){const t=this.availableStates.findIndex(a=>a.id==this.openedState.id);if(t==-1)if(this.openedState.id!=null&&this.openedState.name!=null&&this.openedState.panels!=null&&this.openedState.ts!=null)this.openedState.panels=e.availablePanels.map(a=>a.name),this.availableStates.push(this.openedState);else throw Error("Opened state not in a saveable condition");return Object.assign(this.availableStates[t],this.openedState),this.availableStates}saveAvailableStates(e){this.updateAvailableStates(e),localStorage.setItem("spe-pages",JSON.stringify(this.availableStates))}addPanel(e){this.state.push(e)}removePanel(e){const t=this.state.pageElements.findIndex(a=>a.editorElementId===e);if(t==-1)throw Error(`Element with ID ${e} does not exist`);this.state.pageElements[t].delete(),this.state.pageElements.splice(t,1)}selectAvailableState(e,t){const a=document.createElement("div");a.classList.add("modal"),e.showOverlay(a);const n=document.createElement("table");n.classList.add("border"),this.availableStates.map(i=>{const s=document.createElement("tr"),l=document.createElement("td");l.innerText=i.name!=null&&i.name!=null?i.name:i.id;const r=document.createElement("td");r.innerText=new Date(i.ts).toLocaleDateString();const h=document.createElement("td"),d=document.createElement("button");h.appendChild(d),d.innerText="🗑️",d.onclick=()=>{localStorage.removeItem(i.id);const g=this.availableStates.findIndex(f=>f.id==i.id);this.availableStates.slice(g,1),this.saveAvailableStates(),e.overlayClose(),this.selectAvailableState(e,t)},s.appendChild(l),s.appendChild(r),s.appendChild(h),r.onclick,l.onclick=()=>{t(i.id)},n.appendChild(s)}),a.appendChild(n)}loadState(e,t){const a=this.availableStates.find(l=>l.id==e);if(a===void 0)throw Error(`State with ID ${e} not available in localStorage`);this.openedState=a;const n=localStorage.getItem(e);if(n===null)throw Error(`Data for StateId ${e} was not available in localStorage`);const i=JSON.parse(n),s=i.length;for(let l=0;l<s;l++){let r=t.find(d=>d.name==i[l].panelType);if(r===void 0)throw Error(`Type ${i[l].panelType} not found in available panels. Maybe extension not loaded?`);const h=r.fromObject(i[l]);this.state.pageElements.push(h)}}saveState(e){this.openedState.id===void 0&&(this.openedState.id=c());const t=document.createElement("div");t.classList.add("modal");const a=document.createElement("input");a.type="text",a.value=this.openedState.name!=null?this.openedState.name:"";const n=document.createElement("button");n.innerText="Save",n.onclick=()=>{const s=a.value;if(s===void 0||s==="")throw Error("Input a name");this.openedState.name!=""&&s!=this.openedState.name&&(this.openedState.id=c()),this.openedState.name=s,this.saveAvailableStates(e),this.state.serialize().then(l=>{localStorage.setItem(this.openedState.id,JSON.stringify(l))}),e.overlayClose()};const i=document.createElement("button");i.innerText="Save as",i.onclick=()=>{e.overlayClose(),this.selectAvailableState(e,s=>{if(this.availableStates.find(r=>r.id==s)===null)throw Error(`Could not save current state ${s}, no state with id found.`);this.openedState.id=s,this.saveAvailableStates(e),this.state.serialize().then(r=>{localStorage.setItem(this.openedState.id,JSON.stringify(r))}),e.overlayClose()})},t.appendChild(a),t.appendChild(n),t.appendChild(i),e.showOverlay(t)}purgeOpenedState(){this.state.pageElements.length!=0&&this.state.pageElements.forEach(e=>{this.removePanel(e.editorElementId)})}}class L{constructor(){this.availablePanels=[],this.availablePanels.push(...v),this.stateHandler=new S,this.setupPage(),this.client=new b(()=>{this.displayLogin()})}setupPage(){var s;document.title="SingePageEditor";const e=document.body;for(const l of this.availablePanels){let r=document.createElement("button");r.innerText=l.name,r.classList.add("btn-add-panel"),r.onclick=()=>{this.stateHandler.addPanel(new l.cls(c()))},r.onmouseover=null,e.appendChild(r)}(s=e.firstElementChild)==null||s.classList.add("pageEnd"),e.appendChild(document.createElement("br"));let t=document.createElement("button");t.innerText="Save (Browser)",t.onclick=()=>{this.stateHandler.saveState(this),this.client.isLoggedIn&&this.stateHandler.state.serialize().then(l=>{if(this.stateHandler.openedState.id===void 0)throw Error("Opened state not saveable");this.stateHandler.updateAvailableStates(this),this.client.setOverview(this.stateHandler.availableStates),this.client.saveDocument(this.stateHandler.openedState.id,l)})},e.appendChild(t);let a=document.createElement("button");a.innerText="Load (Browser)",a.onclick=()=>{this.stateHandler.selectAvailableState(this,l=>{this.stateHandler.loadState(l,this.availablePanels),this.overlayClose()})},e.appendChild(a);const n=document.createElement("div");n.id="overlay",n.classList.add("overlay","hidden");const i=document.createElement("div");i.classList.add("close_overlay_button"),i.innerHTML="X",i.onclick=()=>{this.overlayClose()},n.appendChild(i),e.appendChild(n)}addNewEditorElement(e){const t=this.availablePanels.find(a=>a.name==e);if(t===void 0)throw Error(`Type ${e} not found in available panels. Maybe extension not loaded?`);this.stateHandler.addPanel(new t.cls(c()))}loadEditorElement(e){const t=this.availablePanels.find(a=>a.name==e.panelType);if(t===void 0)throw Error(`Type ${e.panelType} not found in available panels. Maybe extension not loaded?`);this.stateHandler.addPanel(new t.cls(e.id))}showOverlay(e){const t=document.getElementById("overlay");if(t==null)throw Error("Overlay element not found");t.appendChild(e),t.classList.remove("hidden"),this.overlayEventBuffer=document.onkeydown,document.onkeydown=a=>{a.key=="Escape"&&this.overlayClose()}}overlayClose(){const e=document.getElementById("overlay");if(e==null)throw Error("Overlay element not found");e.classList.add("hidden");const t=e.firstChild;e.innerHTML="",t!=null&&e.appendChild(t),this.overlayEventBuffer===null||this.overlayEventBuffer===void 0?document.onkeydown=null:document.onkeydown=this.overlayEventBuffer}displayLogin(){const e=this.createElement("div",{classList:["modal"]}),t=this.createElement("input",{});t.type="text";const a=this.createElement("input",{});a.type="password";const n=this.createElement("button",{innerText:"Login",onClick:()=>{this.client.login(t.value,a.value).then(()=>{this.overlayClose()})}}),i=this.createElement("button",{innerText:"Register",onClick:()=>{this.client.register(t.value,a.value).then(()=>{this.overlayClose()})}});e.append(t,a,document.createElement("br"),n,i),this.showOverlay(e)}generateStaticSite(){throw Error("NOT IMPLEMENTED App.generateStaticSite")}createElement(e,t){const a=document.createElement(e);return Object.entries(t).forEach(n=>{var i,s,l;switch(n[0]){case"parent":if(t.afterElement||t.beforeELement)throw Error("Only one can be set: parent or afterElement");(i=t.parent)==null||i.appendChild(a);break;case"afterElement":if(t.parent||t.beforeELement)throw Error("Only one can be set: parent or afterElement");(s=t.afterElement)==null||s.after(a);break;case"beforeElement":if(t.parent||t.afterElement)throw Error("");(l=t.beforeELement)==null||l.before(a);case"classList":a.classList.add(...t.classList??[]);break;case"id":a.id=t.id??a.id;break;case"innerText":a.innerText=t.innerText??a.innerText;break;case"onClick":a.onclick=t.onClick??a.onclick}}),a}}const C=new L;window.App=C;
